---
title: "seurat_mapping_for_cross_species"
author: "Beth Moore"
date: "2023-07-18"
output: html_document
---
# Seurat tansfer mapping for cross species analysis
# do preprocessing on human and pig data (preprocess_crossspecies.Rmd)
# both reference and query should undergo normalization and find variable features,
# then only reference is scaled and undegoes dimentionality reduction

# Load libraries, set wd, and source functions
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# set Rterm: /w5home/bmoore/miniconda3/envs/scRNAseq_best/bin/R
#conda upgrade -c conda-forge --all
#BiocManager::install(version = "3.18")
#BiocManager::install("ComplexHeatmap")
library(dplyr)
library(Seurat)
library(patchwork)
library(scran)
library(BiocParallel)
library(DropletUtils)
library(cowplot)
library(harmony)
library(reticulate)
library(purrr)
library(jsonlite)
library(rmarkdown)
library(ggplot2)
library(scPred)
library(ComplexHeatmap)
library(circlize)
library(colorspace)
library(GetoptLong)
WD <- "/w5home/bmoore/scRNAseq/GAMM/human_data/cowan_cell_2020/"
GIT_DIR <- "/w5home/bmoore/Gamm_scRNAseq/"
use_condaenv("scRNAseq_best", required=TRUE)
setwd(WD)
timestamp <- format(Sys.time(), "%Y%m%d_%H%M%S")
output <- paste0("output_seurat_mapping_", timestamp)
dir.create(output, showWarnings = FALSE)
file.copy(paste0(GIT_DIR,"config.json"), file.path(output, "config.json"))
config <- fromJSON(file.path(output, "config.json"))
output <- paste0(output, "/")
source(paste0(GIT_DIR,"src/sc_pipeline_functions.R"))
```

# read in seurat objects that were preprocessed
```{r read_data}
query.seurat <- readRDS(file = "output_preprocess_test_20240209_145813/querygamm.data.S2_clustered.rds")
ref.seurat <- readRDS(file = "output_preprocess_test_20240209_145813/human_F49i-N-B7_clustered.rds")
```
# get metadata- if needed
```{r metadata}
# get metadata if cell type annotation is needed 
# set type "ref" or "query" ref= metadata.file1, query= metadata.file2
ref.seurat <- get_metadata(ref.seurat, "ref")
query.seurat <- get_metadata(query.seurat, "query")
print(colnames(ref.seurat@meta.data))
print(colnames(query.seurat@meta.data))
```

# some visualizations
```{r visuals}
# feature plots
count_and_feature_plots(ref.seurat,query.seurat)
```
# ref umap and subset metadata
```{r subset_metadata}
ref.seurat.sub <- visualize_and_subset_ref(ref.seurat)
```

# mapping and annotating query datasets
```{r find_anchors_and_transfer}
obj.list <- transfer_anchors(ref.seurat.sub, query.seurat)
print(obj.list)
query.seurat <- obj.list[[1]]
anchors <- obj.list[[2]]
```


# projection of a query onto the reference UMAP structure.
```{r project_query_on_ref}
obj.list <- project_query_on_ref(ref.seurat.sub, query.seurat, anchors)
ref.seurat <- obj.list[[1]]
query.seurat <- obj.list[[2]]
```

# visualize probabilities
```{r visualize_prob}
#  probabilities of each cell in the @meta.data slot of the query Seurat object.
# get labels
labels<- as.vector(unique(colnames(query.seurat@meta.data)))
library(stringr)
labels <- labels[startsWith(labels, "prediction.score.")]
labels<-labels[! labels %in% c('prediction.score.max')]
# visualize the probabilities over the UMAP plot:
pdf(paste0(output, "query_celltype_prediction_featureplot.pdf"), width = 10, height = 10)
print(FeaturePlot(query.seurat, labels, keep.scale = "all"))
dev.off()
```
# get comparison between predicted and manual annotations
```{r get_comparison}
# verify model performance in query data
query.ref.data.table1.2.1<- as.data.frame(crossTab(gamms2.1, "CellType_manual", "predicted.celltype"))
# check out proportion of cells
query.ref.data.table2.2.1<- as.data.frame(crossTab(gamms2.1, "CellType_manual", "predicted.celltype", output = "prop"))
# verify model performance in query data
query.ref.data.table1.2.2<- as.data.frame(crossTab(gamms2.2, "CellType_manual", "predicted.celltype"))
# check out proportion of cells
query.ref.data.table2.2.2<- as.data.frame(crossTab(gamms2.2, "CellType_manual", "predicted.celltype", output = "prop"))
rowvec1 <- c("CdBC","ChBC","RBC","rod","L/M cone","MC","AC","HC")
rowvec2 <- c("BC","rod","L/M cone","MC","AC","HC")
colvec <- c("Bipolar Cells","Rods","Cones","Rods - Muller Glia","Muller Glia",
"Muller Glia - Retinal Prog","Retinal progenitors","Amacrine cells","unknown")
query.ref.data.table2.2.1<- query.ref.data.table2.2.1[order(match(rownames(query.ref.data.table2.2.1), rowvec1)), , drop = FALSE]
query.ref.data.table2.2.1<- query.ref.data.table2.2.1[colvec]
query.ref.data.table2.2.2<- query.ref.data.table2.2.2[order(match(rownames(query.ref.data.table2.2.2), rowvec2)), , drop = FALSE]
query.ref.data.table2.2.2<- query.ref.data.table2.2.2[colvec]
# write out data
write.table(query.ref.data.table1.2.1, file = paste0(output, "query_ref_data_table_s2.1.txt"), sep = "\t")
write.table(query.ref.data.table2.2.1, file = paste0(output, "query_ref_data_table_proportion_s2.1.txt"), sep = "\t")
write.table(query.ref.data.table1.2.2, file = paste0(output, "query_ref_data_table_s2.2.txt"), sep = "\t")
write.table(query.ref.data.table2.2.2, file = paste0(output, "query_ref_data_table_proportion_s2.2.txt"), sep = "\t")
```
# make heatmap
```{r heatmap}
heatmap_func <- function(df){
  # turn df into matrix
  mat <- as.matrix(sapply(df, as.numeric, rownames=TRUE))  
  y <- rownames(df)
  rownames(mat) <- y
  print(df[1,1])
  print(mat[1,1])

  # make heatmap
  hm<- Heatmap(mat, name= "Proportion of cells", column_title = "Cell types - manual", 
             row_title = "Cell types - predicted", column_title_side = "top",row_title_side = "left", 
             col = colorRamp2(c(0, 0.5, 1), c("blue","white","darkred")),
             cluster_columns = F, cluster_rows= F, show_row_dend = F, 
             column_names_gp = gpar(fontsize = 10), show_column_names = T, 
             show_row_names = T, row_names_gp = gpar(fontsize = 10), 
             cell_fun = function(j, i, x, y, width, height, fill) {
               grid.text(sprintf("%.2f", mat[i, j]), x, y, gp = gpar(fontsize = 8))})
  return(hm)
}
hm <- heatmap_func(query.ref.data.table2.2.1)
pdf(file = paste0(output,"celltype_manualvs.predicted_2.1_heatmap.pdf"), width = 7, height = 5)
print(hm)
dev.off()
hm2 <- heatmap_func(query.ref.data.table2.2.2)
pdf(file = paste0(output,"celltype_manualvs.predicted_2.2_heatmap.pdf"), width = 7, height = 5)
print(hm2)
dev.off()
```
```{r save_data}
saveRDS(gamms2.1, file= paste0(output,"gamms2.1_cca_pred.rds"))
saveRDS(gamms2.2, file= paste0(output,"gamms2.2_cca_pred.rds"))
#saveRDS(human_F49B7.seurat, file= paste0(output,"human_F49B7_cca_pred.rds"))
#saveRDS(human_IMR90.seurat, file= paste0(output,"human_IMR90_cca_pred.rds"))
```
# save session info
```{r sessioninfo}
writeLines(capture.output(sessionInfo()), paste0(output,"sessionInfo.txt"))
```
```{r read_data}
#gamms2 <- readRDS(file = "/w5home/bmoore/scRNAseq/GAMM/human_data/reh_cellrep_2020/output_seurat_mapping_20230804_143108/gamms2_rpca_pred.rds")
```